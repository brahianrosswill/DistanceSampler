# Custom Sampler Node Documentation

This document provides detailed information about the custom sampler nodes available in this repository.

## Samplers Overview

The custom samplers are designed to provide advanced control over the diffusion model sampling process. They employ a technique that iteratively refines the denoised image by considering the distances between multiple predictions and, optionally, an unconditional (negative) prediction. This can lead to higher quality images and better adherence to prompts.

The core logic revolves around the `fast_distance_weights` function, which calculates weights for different predictions based on their similarity, and `matrix_batch_slerp` for spherically interpolating these predictions.

There are two main custom sampler nodes:

*   **`SamplerDistance`**: A simplified sampler with essential controls.
*   **`SamplerDistanceAdvanced`**: Exposes all available parameters for fine-grained control over the sampling process.

## `SamplerDistance`

This node provides a simpler interface to the custom distance-based sampling method, offering control over resampling and CFG++.

### Parameters

| Name           | Type    | Default | Min | Max | Step | Tooltip                                                                                                                                        | Description                                                                                                | Potential Impact                                                                                               |
|----------------|---------|---------|-----|-----|------|------------------------------------------------------------------------------------------------------------------------------------------------|------------------------------------------------------------------------------------------------------------|----------------------------------------------------------------------------------------------------------------|
| `resample`     | `INT`   | `3`     | `-1`  | `32`  | `1`  | `0 all along gives Euler. 1 gives Heun.\nAnything starting from 2 will use the distance method.\n-1 will do remaining steps + 1 as the resample value. This can be pretty slow.` | Number of resampling steps to perform at each main sampling step. -1 for dynamic adjustment.                 | Controls the level of refinement at each step; higher values increase computation time but potentially quality.    |
| `resample_end` | `INT`   | `-1`    | `-1`  | `32`  | `1`  | `How many resamples for the end. -1 means constant.`                                                                                           | End value for dynamic resampling step calculation.                                                         | Influences how the number of resampling steps changes over the course of the sampling process.                 |
| `cfgpp`        | `BOOLEAN` | `True`  |     |     |      | `Controls whether to use CFG++ sampling. When enabled, you should set CFG to a fairly low value.`                                                | Enables Classifier-Free Guidance++.                                                                        | Improves adherence to the conditioning prompt, potentially enhancing output quality and coherence.             |

## `SamplerDistanceAdvanced`

This node exposes all available parameters for the custom distance-based sampling method, allowing for maximum control and experimentation. It includes all parameters from `SamplerDistance`.

### Parameters

| Name                      | Type    | Default | Min      | Max     | Step | Tooltip                                                                                                                                                                                          | Description                                                                                                                               | Potential Impact                                                                                                                                                               |
|---------------------------|---------|---------|----------|---------|------|--------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------|-------------------------------------------------------------------------------------------------------------------------------------------|--------------------------------------------------------------------------------------------------------------------------------------------------------------------------------|
| `resample`                | `INT`   | `3`     | `-1`       | `32`    | `1`  | `0 all along gives Euler. 1 gives Heun.\nAnything starting from 2 will use the distance method.\n-1 will do remaining steps + 1 as the resample value. This can be pretty slow.`                       | Number of resampling steps to perform at each main sampling step. -1 for dynamic adjustment.                                              | Controls the level of refinement at each step; higher values increase computation time but potentially quality.                                                                |
| `resample_end`            | `INT`   | `-1`    | `-1`       | `32`    | `1`  | `How many resamples for the end. -1 means constant.`                                                                                                                                             | End value for dynamic resampling step calculation.                                                                                      | Influences how the number of resampling steps changes over the course of the sampling process.                                                                               |
| `cfgpp`                   | `BOOLEAN` | `True`  |          |         |      | `Controls whether to use CFG++ sampling. When enabled, you should set CFG to a fairly low value.`                                                                                                  | Enables Classifier-Free Guidance++.                                                                                                     | Improves adherence to the conditioning prompt, potentially enhancing output quality and coherence.                                                                         |
| `eta`                     | `FLOAT` | `0.0`   | `0.0`    | `32.0`  | `0.01` | `Controls the ancestralness of the main sampler steps. 0.0 means to use non-ancestral sampling. Note: May not work well with some of the other options.`                                              | Controls the ancestralness of the main sampler steps. 0.0 means to use non-ancestral sampling.                                            | Affects the noise schedule and the path taken during sampling. Higher values introduce more noise.                                                                           |
| `s_noise`                 | `FLOAT` | `1.0`   | `-100.0` | `100.0` | `0.01` | `Scale factor for ancestral noise added during sampling. Generally should be left at 1.0 and only has an effect when ancestral sampling is used.`                                                   | Scale factor for ancestral noise added during sampling.                                                                                  | Only has an effect when ancestral sampling (eta > 0) is used. Modifies the amount of noise added at each ancestral step.                                                      |
| `distance_step_eta`       | `FLOAT` | `0.0`   | `0.0`    | `32.0`  | `0.01` | `Experimental option that allows using ancestral sampling for the internal distance steps. When used, should generally be a fairly low value such as 0.25. 0.0 means to use non-ancestral sampling for the internal distance steps.` | Allows using ancestral sampling for the internal distance steps.                                                                        | Experimental. Introduces noise within the resampling loop.                                                                                                                     |
| `distance_step_s_noise`   | `FLOAT` | `1.0`   | `-100.0` | `100.0` | `0.01` | `Scale factor for ancestral noise added in the internal distance steps. Generally should be left at 1.0 and only has an effect when distance_step_eta is non-zero.`                                  | Scale factor for ancestral noise added in the internal distance steps.                                                                    | Only has an effect when `distance_step_eta` > 0. Modifies the amount of noise added during resampling.                                                                      |
| `use_softmax`             | `BOOLEAN` | `False` |          |         |      | `Rather than using a min/max normalization and an exponent will use a softmax instead.`                                                                                                          | Uses the softmax function for calculating distance weights.                                                                               | Affects the distribution of weights assigned to different tensors based on their distances.                                                                                  |
| `use_slerp`               | `BOOLEAN` | `False` |          |         |      | `Will SLERP the predictions instead of doing a weighted average. The difference is more obvious when using use_negative.`                                                                        | Uses Spherical Linear Interpolation (SLERP) to combine weighted tensors in `fast_distance_weights`.                                       | Provides a smooth interpolation between tensors, potentially leading to more coherent results, especially when `use_negative` is active.                                   |
| `perp_step`               | `BOOLEAN` | `False` |          |         |      | `Experimental, not yet recommended.`                                                                                                                                                             | Enables a perpendicular step operation on the denoised direction.                                                                       | Experimental. Likely influences the direction of the denoising step, potentially avoiding artifacts or improving consistency.                                                |
| `use_negative`            | `BOOLEAN` | `False` |          |         |      | `Will use the negative prediction to prepare the distance scores. This tends to give images with less errors from my testing.`                                                                      | Incorporates the unconditional output into the distance weight calculation.                                                               | Influences the weighting based on the distance from the unconditional sample, potentially related to negative prompting strategies. Tends to give images with fewer errors.     |
| `smooth`                  | `BOOLEAN` | `False` |          |         |      | `Not recommended, will make everything brighter. Not smoother.`                                                                                                                                  | Enables a smoothing operation on the denoised output during resampling.                                                                   | Not recommended. Likely reduces noise or artifacts in the intermediate denoised results, but can make images brighter.                                                       |
| `sharpen`                 | `BOOLEAN` | `False` |          |         |      | `Not recommended, attempts to sharpen the results but instead tends to make things fuzzy.`                                                                                                       | Enables a sharpening operation on the denoised direction.                                                                                 | Not recommended. Likely enhances the details and sharpness of the generated image, but can make things fuzzy.                                                                |
| `distance_first`          | `INT`   | `0`     | `-10000` | `10000` | `1`  | `First step to use distance sampling. You can use negative values to count from the end. Note: Steps are zero-based.`                                                                                | First step (0-indexed) to apply the distance sampling method. Negative values count from the end.                                         | Controls when the distance-based resampling begins.                                                                                                                          |
| `distance_last`           | `INT`   | `-1`    | `-10000` | `10000` | `1`  | `Last step to use distance sampling. You can use negative values to count from the end. Note: Steps are zero-based.`                                                                                 | Last step (0-indexed) to apply the distance sampling method. Negative values count from the end. -1 means up to the last step.             | Controls when the distance-based resampling ends.                                                                                                                            |
| `eta_first`               | `INT`   | `0`     | `-10000` | `10000` | `1`  | `First step to use ancestral sampling. Only applies when ETA is non-zero. You can use negative values to count from the end. Note: Steps are zero-based.`                                                 | First step (0-indexed) to apply ancestral sampling (if eta > 0). Negative values count from the end.                                      | Controls when ancestral noise addition begins.                                                                                                                               |
| `eta_last`                | `INT`   | `-1`    | `-10000` | `10000` | `1`  | `Last step to use ancestral sampling. Only applies when ETA is non-zero. You can use negative values to count from the end. Note: Steps are zero-based.`                                                  | Last step (0-indexed) to apply ancestral sampling (if eta > 0). Negative values count from the end. -1 means up to the last step.          | Controls when ancestral noise addition ends.                                                                                                                                 |
| `distance_eta_first`      | `INT`   | `0`     | `-10000` | `10000` | `1`  | `First step to use ancestral sampling for the distance steps. Only applies when distance ETA is non-zero. You can use negative values to count from the end. Note: Steps are zero-based.`              | First step (0-indexed) to apply ancestral sampling within distance steps (if `distance_step_eta` > 0). Negative values count from the end. | Controls when ancestral noise addition begins within resampling loops.                                                                                                       |
| `distance_eta_last`       | `INT`   | `-1`    | `-10000` | `10000` | `1`  | `Last step to use ancestral sampling for the distance steps. Only applies when distance ETA is non-zero. You can use negative values to count from the end. Note: Steps are zero-based.`               | Last step (0-indexed) to apply ancestral sampling within distance steps (if `distance_step_eta` > 0). Negative values count from the end. -1 means up to the last step. | Controls when ancestral noise addition ends within resampling loops.                                                                                                         |

### General Advice for Usage

*   Start with `SamplerDistance` or `SamplerDistanceAdvanced` with default settings to get a feel for the sampler.
*   The `resample` parameter is key: `0` is Euler, `1` is Heun-like, and `>=2` activates the core distance logic. Higher values mean more computation but potentially better refinement.
*   `cfgpp` (CFG++) is generally recommended for better prompt adherence; ensure your main CFG scale is adjusted accordingly (usually lower).
*   When using `SamplerDistanceAdvanced`:
    *   `eta` controls ancestral noise. `0.0` is deterministic (within GPU limits).
    *   `use_negative` can significantly improve results by guiding the sampler away from undesired concepts, especially when combined with `use_slerp`.
    *   Parameters like `sharpen` and `smooth` are marked as "not recommended" in their tooltips as their effects can be unpredictable or counterproductive. Use with caution.
    *   The `*_first` and `*_last` parameters allow you to control at which steps certain features (distance sampling, eta noise) are active. This can be useful for fine-tuning or saving computation. `-1` for a `_last` parameter typically means "until the end of the sampling process".

Experimentation is encouraged to find the optimal settings for your specific use cases and models.
